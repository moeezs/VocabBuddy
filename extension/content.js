(()=>{"use strict";var t,e;function n(t,e,n){return t?(t.backgroundColor=e,t.fontColor=n,t):{fontColor:n,backgroundColor:e}}!function(t){t[t.DictsOfLang=0]="DictsOfLang",t[t.GetCurrentDictionary=1]="GetCurrentDictionary",t[t.SetCurrentDictionary=2]="SetCurrentDictionary",t[t.AddNewDictionary=3]="AddNewDictionary",t[t.GetExistingDictionary=4]="GetExistingDictionary",t[t.UpdateExistingDictionary=5]="UpdateExistingDictionary",t[t.DeleteExitingDictionary=6]="DeleteExitingDictionary",t[t.GetLanguages=7]="GetLanguages",t[t.SearchWordURL=8]="SearchWordURL",t[t.StorePageData=9]="StorePageData",t[t.DeletePageData=10]="DeletePageData",t[t.GetPageData=11]="GetPageData",t[t.GetCurrentActivation=12]="GetCurrentActivation",t[t.SetCurrentActivation=13]="SetCurrentActivation",t[t.ShowDeleteHighlightsCM=14]="ShowDeleteHighlightsCM",t[t.HideDeleteHighlightsCM=15]="HideDeleteHighlightsCM",t[t.GetAllDomains=16]="GetAllDomains",t[t.GetSeeSiteData=17]="GetSeeSiteData",t[t.GetAllExtensionData=18]="GetAllExtensionData",t[t.LoadExtensionData=19]="LoadExtensionData",t[t.GetLabelsForSite=20]="GetLabelsForSite",t[t.GetURLsForLabel=21]="GetURLsForLabel",t[t.AddLabelEntry=22]="AddLabelEntry",t[t.RemoveLabelEntry=23]="RemoveLabelEntry",t[t.GetAllLabels=24]="GetAllLabels"}(t||(t={})),function(t){t[t.ActivationStateChange=0]="ActivationStateChange",t[t.DeleteChosenHighlight=1]="DeleteChosenHighlight",t[t.StartQuiz=2]="StartQuiz",t[t.ChangeHighlightStyle=3]="ChangeHighlightStyle"}(e||(e={}));const i="vf-highlighted",o="vf-highlighted-hover";function s(e){if(null!==e&&""!==e){console.log(`Looking up: ${e}`);let n={messageType:t.SearchWordURL,payload:{word:e}};chrome.runtime.sendMessage(n)}}function h(t){let e=document.body;for(let n=0;n<t.length;n++)e=e.childNodes[t[n]];return e}function r(t){let e=[],n=t;const i=document.body;for(;n!==i;){let t=n.parentNode,i=-1;for(let e=0;e<t.childNodes.length;e++)if(t.childNodes[e]===n){i=e;break}e.push(i),n=t}return e.reverse(),e}function l(t){return t.nodeType===Node.TEXT_NODE}function d(t){return t instanceof Element&&null!=(e=t).classList&&e.classList.contains(i);var e}function a(t){return/\s/.test(t)}const g="ED",c=" ";class u{constructor(t,e){this.char=e,this.parent=t,this.children=new Map}appendWord(t){if(0===(t=(t=(t=t.trim()).replace(/\s\s+/g,c)).toLocaleLowerCase()).length)return;let e=this;for(let n=0;n<t.length;n++){let i,o=t.charAt(n);e.children.has(o)?i=e.children.get(o):(i=new u(e,o),e.children.set(o,i)),e=i}e.children.set(g,new u(e,g))}getNodeWithChar(t){return a(t)&&t!==c&&(t=c),this.children.get(t)}isRoot(){return null===this.parent}isEndOfWord(){return this.char===g}removeWord(){if(!this.isEndOfWord())throw Error(`Node char ${this.char} is not end of word marker`);let t=this;for(;!t.isRoot();){let e=t.parent;0===t.children.size&&(e.children.delete(t.char),t.parent=null),t=e}}setOfWords(){let t=new Set;return this.setOfWordsHelper("",t),t}setOfWordsHelper(t,e){this.isEndOfWord()?e.add(t):(t+=this.char,this.children.forEach(((n,i)=>{n.setOfWordsHelper(t,e)})))}}class f{constructor(t,e){this.nodeIndex=t,this.charIndex=e,this.lastAdvanceIncreasedNode=!1}isBeforeOrIs(t){return t.nodeIndex>=this.nodeIndex||t.charIndex>=this.charIndex}getCurrentChar(t){if(t.length<=this.nodeIndex)return null;let e=t[this.nodeIndex].textContent;return e.length<=this.charIndex?null:e.charAt(this.charIndex)}advance(t){return this.changeCursor(t,((t,e)=>this.advanceByOne(t,e)))}goBack(t){return this.changeCursor(t,((t,e)=>this.goBackByOne(t,e)))}changeCursor(t,e){let n=t[this.nodeIndex].textContent,i=n.charAt(this.charIndex);if(!a(i))return e(n,t);let o=this.nodeIndex,s=this.charIndex,h=this.lastAdvanceIncreasedNode;for(;a(i);){if(!e(n,t))return this.lastAdvanceIncreasedNode=h,this.nodeIndex=o,this.charIndex=s,!1;n=t[this.nodeIndex].textContent,i=n.charAt(this.charIndex)}return this.lastAdvanceIncreasedNode=this.nodeIndex!==o,!0}advanceByOne(t,e){if(this.charIndex++,t.length<=this.charIndex){if(this.nodeIndex++,e.length<=this.nodeIndex)return this.nodeIndex--,this.charIndex--,!1;this.charIndex=0,this.lastAdvanceIncreasedNode=!0}else this.lastAdvanceIncreasedNode=!1;return!0}goBackByOne(t,e){if(this.charIndex--,this.charIndex<0){if(this.nodeIndex--,this.nodeIndex<0)return this.nodeIndex++,this.charIndex++,!1;t=e[this.nodeIndex].textContent,this.charIndex=t.length-1,this.lastAdvanceIncreasedNode=!0}else this.lastAdvanceIncreasedNode=!1;return!0}}function p(t,e){let n=function(t){const e=new u(null,"");for(const n of t)e.appendWord(n);return e}(t);return function(t,e,n){if(0===t.children.size)return null;let i=new f(0,0),o=new f(0,0);for(;i.nodeIndex<e.length;){let s=C(i,o,e,t);if(s.isRoot()){if(!i.advance(e))break}else{const h=e[o.nodeIndex].parentNode;s.removeWord();const d=i.nodeIndex,a=o.nodeIndex,g=e.slice(d,a+1).map(r),c=i.charIndex,u=o.charIndex+1,f=new Range;if(f.setStart(e[i.nodeIndex],c),f.setEnd(e[o.nodeIndex],u),n({startOffset:c,endOffset:u,word:f.toString(),nodePath:g}),0===t.children.size)return null;e=e.slice(a+1);const p=g[g.length-1],m=p[p.length-1],C=h.childNodes[m+2];null!==C&&null!==C.textContent&&0!==C.textContent.trim().length&&(console.assert(l(C)),e.unshift(C)),i.charIndex=0,i.nodeIndex=0}o.charIndex=0,o.nodeIndex=0,o.lastAdvanceIncreasedNode=!1}return t.setOfWords()}(n,m(document.body),e)}function m(t){let e=[];for(let n=t.firstChild;n;n=n.nextSibling)if(n.nodeType===Node.TEXT_NODE&&null!==n.textContent&&0!==n.textContent.length)e.push(n);else{let t=m(n);for(let n=0;n<t.length;n++)e.push(t[n])}return e}function C(t,e,n,i){e.nodeIndex=t.nodeIndex,e.charIndex=t.charIndex,e.lastAdvanceIncreasedNode=!1;let o=i,s=!1;for(;;){let t=e.getCurrentChar(n).toLowerCase(),i=o.getNodeWithChar(t);if(void 0===i){if(e.lastAdvanceIncreasedNode&&(i=o.getNodeWithChar(c),void 0!==i)){o=i;continue}s=!0;break}if(!e.advance(n))break;o=i}for(s&&e.goBack(n);!o.isRoot();){let t=e.getCurrentChar(n).toLocaleLowerCase(),i=!1;if(t===o.char||a(t)&&a(o.char)){if(o.children.has(g))return o.getNodeWithChar(g);o=o.parent,i=!e.goBack(n)}else{if(!a(o.char)||!e.lastAdvanceIncreasedNode)throw new Error(`Unexpected character difference: Trie: ${o.char}, \n                    Text: ${t}`);o=o.parent,a(t)&&(i=!e.goBack(n))}if(i)throw new Error(`Failed to go back at index ${e.charIndex} of text \n                ${n[e.nodeIndex].textContent}`)}return i}function x(t){return parseInt(t.id.substring(5,t.id.lastIndexOf("_")))}function w(t){let e=t.id;return parseInt(e.substring(e.lastIndexOf("_")+1,e.length))}function y(t,e,n,i,o,s,h,r,a){if(!t.hasChildNodes())return;let g=t.childNodes;for(let t=o;t<g.length;t++){let o=g[t];if(!l(o))if(d(o)){const t=x(o);let h=r.highlights[t],l=w(o);h.word.nodePath[l][e]+=n,s&&(h.word.startOffset+=i,1===h.word.nodePath.length&&(h.word.endOffset+=i),s=!1),null!==a&&a[0]>t&&(a[0]=t,a=null)}else s=s&&l(o),h&&y(o,e,n,0,0,!1,h,r,a)}}class N{constructor(t,e,n){this.word=t,this.id=e,this.manager=n,this.highlightNodes=[]}highlightWord(){let t=this.word.nodePath.map(h),e="";for(let n=0;n<t.length;n++){let i,o=t[n],s=0;i=null===o.textContent?0:o.textContent.length,o===t[0]&&(s=this.word.startOffset),o===t[t.length-1]&&(i=this.word.endOffset);let h=this.constructHighlightNode(n),r=new Range;r.setStart(o,s),r.setEnd(o,i),r.surroundContents(h),e+=r.toString()}if(e.replace(/\s+/g,"").toLowerCase()!==this.word.word.replace(/\s+/g,"").toLowerCase())throw this.unHighlightWord(),`${this.word.word} does not match ${e}`}unHighlightWord(){let t=new Map;for(let e=0;e<this.highlightNodes.length;e++){let n=this.highlightNodes[e],i=n.parentNode,o=t.get(i);void 0===o&&(t.set(i,[]),o=t.get(i)),o.push(n)}t.forEach(((t,e)=>{this.unHighlightNodes(e,t)})),this.highlightNodes=[]}syncIdsOfHighlightNodes(){for(let t=0;t<this.highlightNodes.length;t++)this.highlightNodes[t].setAttribute("id",`word_${this.id}_${t}`)}applyStyle(t){const e=t.fontColor,n=t.backgroundColor;for(let t=0;t<this.highlightNodes.length;t++){const i=this.highlightNodes[t];i.style.color=e,i.style.backgroundColor=n}}unHighlightNodes(t,e){for(let n of e){let e;for(e=0;e<t.childNodes.length&&t.childNodes[e]!==n;e++);console.assert(e>0&&l(t.childNodes[e-1]),"Node before not text"),console.assert(e<t.childNodes.length-1&&l(t.childNodes[e+1]),"Node after is not text");let i=e-1,o=t.childNodes[i];for(null===o.textContent&&(o.textContent=""),o.textContent+=n.textContent,t.removeChild(n);i>0&&l(t.childNodes[i-1]);)null===o.textContent&&(o.textContent=""),t.childNodes[i-1].textContent+=o.textContent,t.removeChild(o),i--,o=t.childNodes[i];for(;i<t.childNodes.length-1&&l(t.childNodes[i+1]);){let e=t.childNodes[i+1];null===o.textContent&&(o.textContent=""),o.textContent+=e.textContent,t.removeChild(e)}}}constructHighlightNode(e){let n=document.createElement("div");return n.setAttribute("id",`word_${this.id}_${e}`),n.setAttribute("class",i),n.addEventListener("click",(()=>{s(this.word.word)})),n.addEventListener("contextmenu",(()=>{this.manager.indexToDelete=this.id})),n.addEventListener("mouseover",(()=>{let e={messageType:t.ShowDeleteHighlightsCM,payload:null};chrome.runtime.sendMessage(e);let n=document.querySelectorAll(`[id^=word_${this.id}_]`);for(let t of n)t.classList.add(o)})),n.addEventListener("mouseout",(()=>{let e={messageType:t.HideDeleteHighlightsCM,payload:null};chrome.runtime.sendMessage(e);let n=document.querySelectorAll(`[id^=word_${this.id}_]`);for(let t of n)t.classList.remove(o)})),this.highlightNodes.push(n),n}}const E="quiz_counter",v="close_the_quiz",I="word_questioning",S="next";function D(t,e){if(l(t))return t;if(!t.hasChildNodes())return null;let n,i,o;for(e?(n=t.childNodes.length-1,i=t=>t>=0,o=t=>t-1):(n=0,i=e=>e<t.childNodes.length,o=t=>t+1);i(n);n=o(n)){let i=D(t.childNodes[n],e);if(null!==i&&l(i))return i}return null}function W(t,e,n,i,o){const s=t.parentNode;if(null==s||s.parentNode,l(t))return i.push(t),!!t.isEqualNode(n)||!!t.isEqualNode(e)&&(null===s?e.isEqualNode(n):W(s,e,n,i,o));{if(d(t))throw new Error("Cannot have highlight node in highlight node");let h=t.childNodes;if(h.length>0){let s=o.get(t);void 0===s&&(s=0,o.set(t,0));for(let r=s;r<h.length;r++){let s=h.item(r);if(!i.includes(s)&&(o.set(t,r+1),W(s,e,n,i,o)))return!0}}return!t.isEqualNode(document.body)&&null!==s&&W(s,e,n,i,o)}}function A(t){const e=t.toString().trim();if(0===e.length)return null;const n=t.getRangeAt(0);let i=D(n.startContainer,!1);if(null===i)return null;let o=i.isEqualNode(n.startContainer)?n.startOffset:0,s=D(n.endContainer,!0);if(null===s)return null;let h=s.isEqualNode(n.endContainer)?n.endOffset:null===s.textContent?0:s.textContent.length,l=function(t){let e=r(t),n=new Map,i=t;for(let t=e.length-1;t>=0;t--){if(d(i))return null;let o=i.parentNode;n.set(o,e[t]),i=o}return n}(i);if(null===l)return null;let a=[];return W(i,i,s,a,l)?1===a.length&&o===h?null:{word:e,startOffset:o,endOffset:h,nodePath:a.map(r)}:null}function L(e,n){let i={wordEntries:e.getWordEntries(),missingWords:n};const o=e.getStyleOptions();o&&(i.highlightOptions=o);const s=document.title;""!==s&&(i.title=s);let h={messageType:t.StorePageData,payload:{url:window.location.href,data:i}};chrome.runtime.sendMessage(h)}const O=new class{constructor(){this.highlights=[],this.indexToDelete=-1}setStyleOptionsFromSiteData(t){this.highlightStyleOptions=t.highlightOptions}setStyleOptions(t){this.highlightStyleOptions=t}getStyleOptions(){return this.highlightStyleOptions}applyHighlightStyle(){if(this.highlightStyleOptions)for(let t=0;t<this.highlights.length;t++)this.highlights[t].applyStyle(this.highlightStyleOptions)}highlight(t){let e=new N(t,this.highlights.length,this);this.insertHighlightData(e),e.highlightWord(),this.highlightStyleOptions&&e.applyStyle(this.highlightStyleOptions)}highlightAllData(t){try{if(t.missingWords.length>0)throw"SiteData has missing words, attempting to find them";for(let e=0;e<t.wordEntries.length;e++){let n=new N(t.wordEntries[e],e,this);n.highlightWord(),this.highlights.push(n)}return!0}catch(e){let n=this.freshRehighlight(t);return t.missingWords=null!==n?Array.from(n):[],t.wordEntries=this.getWordEntries(),!1}finally{this.applyHighlightStyle()}}getWordEntries(){return this.highlights.map((t=>t.word))}deleteHighlight(){let t=this.highlights[this.indexToDelete];this.updateDataBeforeDelete(t),t.unHighlightWord(),this.highlights.splice(this.indexToDelete,1);for(let t=this.indexToDelete;t<this.highlights.length;t++)this.highlights[t].id--,this.highlights[t].syncIdsOfHighlightNodes();this.indexToDelete=-1}unHighlightWord(t){t>=0&&t<this.highlights.length&&this.highlights[t].unHighlightWord()}insertHighlightData(t){var e;let n=new Map;for(let i=0;i<t.word.nodePath.length;i++){let o=t.word.nodePath[i],s=h(o).parentNode;n.has(s)||n.set(s,[]),null===(e=n.get(s))||void 0===e||e.push(o[o.length-1])}let i=[this.highlights.length];n.forEach(((e,n)=>{const o=e[e.length-1],s=r(n).length,h=-t.word.endOffset;y(n,s,2*e.length,h,o+1,!0,!0,this,i)})),t.id=i[0],this.highlights.splice(t.id,0,t);for(let e=t.id+1;e<this.highlights.length;e++){let t=this.highlights[e];t.id=t.id+1,t.syncIdsOfHighlightNodes()}}updateDataBeforeDelete(t){let e=new Map;for(let n=0;n<t.highlightNodes.length;n++){let i=t.highlightNodes[n],o=i.parentNode,s=e.get(o);void 0===s?(e.set(o,[i]),s=e.get(o)):s.push(i)}e.forEach(((e,n)=>{this.updateDeletesForSameRow(t,e,n)}))}updateDeletesForSameRow(t,e,n){let i,o=e[e.length-1],s=n.childNodes;for(i=0;i<s.length&&s[i]!==o;i++);console.assert(i<s.length,"ERROR, end node not found");let h=-2*t.highlightNodes.length,a=o===t.highlightNodes[t.highlightNodes.length-1],g=0;if(a){g=null===o.textContent?0:o.textContent.length,console.assert(0!=i,"Assumption on how hilights made broken");let t=i-1;const n=x(e[0]);for(;t>=0&&l(s[t])||d(s[t])&&x(s[t])===n;){let e=s[t].textContent;g+=null===e?0:e.length,t--}}y(n,r(n).length,h,g,i+1,a,!0,this,null)}freshRehighlight(t){for(let t=0;t<this.highlights.length;t++)this.highlights[t].unHighlightWord();for(;this.highlights.length>0;)this.highlights.pop();let e=new Set;for(let n=0;n<t.wordEntries.length;n++)e.add(t.wordEntries[n].word.trim());for(let n=0;n<t.missingWords.length;n++)e.add(t.missingWords[n].trim());return p(e,(t=>this.highlight(t)))}},b=new class{constructor(){this.quizWordList=[],this.isQuizActive=!1,this.wordsEncountered=0,this.myDomParser=new DOMParser}shuffle(t){let e,n;for(let i=0;i<t.length;i++)e=Math.floor(Math.random()*t.length),n=t[i],t[i]=t[e],t[e]=n}stringToElement(t){return this.myDomParser.parseFromString(t,"text/html").body.childNodes[0]}addQuizContainer(){let t=document.createElement("div");return t.id="quiz_container_box",t.setAttribute("class","dark_screen"),document.body.appendChild(t),t}updateQuizCounter(){let t=document.getElementById(E);null!==t?t.textContent=`${this.wordsEncountered}/${this.wordsEncountered+this.quizWordList.length-1}`:console.error(`Could not find element ${E}. \n                Check that quiz div was loaded propperly and contains an element with that id`)}setUpWordsAndCounter(t){this.quizWordList=[];for(let e=0;e<t.wordEntries.length;e++){let n=t.wordEntries[e];this.quizWordList.push(n.word)}for(let e=0;e<t.missingWords.length;e++)this.quizWordList.push(t.missingWords[e]);this.shuffle(this.quizWordList),this.wordsEncountered=1,this.updateQuizCounter()}setUpQuiz(t,e){this.setUpWordsAndCounter(t);let n=document.getElementById(v);if(null===n)return void console.error(`Could not find element ${v}. \n                Check that quiz div was loaded propperly and contains an element with that id`);n.addEventListener("click",(()=>{null!==e.parentNode&&e.parentNode.removeChild(e),this.isQuizActive=!1}));let i=document.getElementById(I);if(null===i)return void console.error(`Could not find element ${I}. \n            Check that quiz div was loaded propperly and contains an element with that id`);i.textContent=this.quizWordList[this.quizWordList.length-1],i.addEventListener("click",(()=>{s(i.textContent)}));let o=document.getElementById(S);null!==o?(o.addEventListener("click",(()=>{this.quizWordList.pop(),0===this.quizWordList.length?this.setUpWordsAndCounter(t):(this.wordsEncountered++,this.updateQuizCounter()),i.textContent=this.quizWordList[this.quizWordList.length-1]})),this.isQuizActive=!0):console.error(`Could not find element ${S}. \n                Check that quiz div was loaded propperly and contains an element with that id`)}loadQuizHTML(t){!this.isQuizActive&&t.wordEntries.length+t.wordEntries.length>0&&fetch(chrome.runtime.getURL("cross-page-assets/quiz.html")).then((t=>t.text())).then((e=>{let n=this.addQuizContainer(),i=this.stringToElement(e);n.appendChild(i),this.setUpQuiz(t,n)}))}},H=[];let z=!1;const T=document.onmouseup;function k(){let e={messageType:t.GetPageData,payload:{url:window.location.href}};chrome.runtime.sendMessage(e,(t=>{O.setStyleOptionsFromSiteData(t);const e=!O.highlightAllData(t);for(let e=0;e<t.missingWords.length;e++)H.push(t.missingWords[e]);(e||(0!==t.missingWords.length||0!==t.wordEntries.length)&&void 0===t.title&&""!==document.title)&&L(O,H),document.onmouseup=t=>{let e=window.getSelection();if(0===t.button&&null!==e){let t=A(e);null!==t&&(O.highlight(t),L(O,H))}}}))}function q(t){if(console.log(`REQUEST MADE TO CONTENT SCRIPT: ${t.messageType}`),null==(o=t)||void 0===o.messageType)return i=t,void console.error(`unexpected request structure: ${JSON.stringify(i)}`);var i,o;switch(t.messageType){case e.DeleteChosenHighlight:O.deleteHighlight(),L(O,H);break;case e.ActivationStateChange:if(function(t){return null!=t&&void 0!==t.newActivatedState}(t.payload)){if(t.payload.newActivatedState&&!z)k();else if(!t.payload.newActivatedState&&z){for(let t=0;t<O.highlights.length;t++)O.unHighlightWord(t);O.highlights=[],O.indexToDelete=-1,document.onmouseup=T}z=t.payload.newActivatedState}break;case e.StartQuiz:{const t={wordEntries:O.getWordEntries(),missingWords:H};b.loadQuizHTML(t);break}case e.ChangeHighlightStyle:{let t=O.getStyleOptions();t=function(t){return void 0!==t&&"#000000"===t.fontColor&&"#ffff01"===t.backgroundColor}(t)?n(t,"#0008fa","#ffffff"):n(t,"#ffff01","#000000"),O.setStyleOptions(t),O.applyHighlightStyle(),L(O,H);break}default:console.log(`CONTENT_REQUEST UNKNOWN: ${t.messageType}`)}}setTimeout((()=>{let e={messageType:t.GetCurrentActivation,payload:null};chrome.runtime.sendMessage(e,(t=>{z=t,z&&k(),chrome.runtime.onMessage.addListener(q)}))}),800)})();

//NOTE: CODE IS RAN THROUGH A MINIFIER TO OPTIMIZE SPEED OF REQUESTS AND QUERIES, 